{% extends 'base.html' %}

{% block content %}
<div class="game-info">
    <div>åœ°é›·: <span id="mine-count">{{ game.mines }}</span></div>
    <div>æ ‡è®°: <span id="flag-count">0</span></div>
    <div>æ—¶é—´: <span id="time">{{ used_time }}</span>ç§’</div>
    {% if game.is_completed %}
    <div class="game-status">
        {% if game.is_success %}
            <span class="status-win">âœ… èƒœåˆ©</span>
        {% else %}
            <span class="status-lose">ğŸ’¥ å¤±è´¥</span>
        {% endif %}
    </div>
    {% endif %}
</div>

<div class="controls">
    <button onclick="window.location.href='{% url "game:new_game" %}'">æ–°æ¸¸æˆ</button>
    <div id="start-time" style="margin-top: 10px; font-size: 14px; color: #666;">
        {% if start_time_str %}æ¸¸æˆå¼€å§‹æ—¶é—´: {{ start_time_str }}{% endif %}
    </div>
</div>

<div class="board-container">
    <div class="board" id="board"></div>
</div>

<div class="message" id="message"></div>

<style>
.status-win {
    color: #4CAF50;
    font-weight: bold;
    animation: celebrate 2s ease-in-out;
}

.status-lose {
    color: #f44336;
    font-weight: bold;
}

@keyframes celebrate {
    0%, 100% { transform: scale(1); }
    25% { transform: scale(1.1); }
    50% { transform: scale(1.05); }
    75% { transform: scale(1.1); }
}

.message.win {
    background: linear-gradient(45deg, #4CAF50, #45a049);
    color: white;
    padding: 15px;
    border-radius: 8px;
    font-size: 18px;
    font-weight: bold;
    text-align: center;
    margin: 20px 0;
    animation: winAnimation 3s ease-in-out;
}

.message.lose {
    background: linear-gradient(45deg, #f44336, #da190b);
    color: white;
    padding: 15px;
    border-radius: 8px;
    font-size: 18px;
    font-weight: bold;
    text-align: center;
    margin: 20px 0;
}

@keyframes winAnimation {
    0% { transform: scale(0.8); opacity: 0; }
    20% { transform: scale(1.1); opacity: 1; }
    40% { transform: scale(0.95); }
    60% { transform: scale(1.05); }
    80% { transform: scale(0.98); }
    100% { transform: scale(1); }
}
</style>

<script>
    // é¢„ç¼–è¯‘æ¨¡æ¿æ•°æ®
    const GAME_DATA = {
        id: {{ game.id }},
        rows: {{ game.rows }},
        cols: {{ game.cols }},
        mines: {{ game.mines }},
        state: {{ state_matrix|safe }},
        mines_matrix: {{ mines_matrix|safe }},
        ended: {{ game.is_completed|yesno:"true,false" }},
        is_success: {{ game.is_success|yesno:"true,false" }},
        used_time: parseFloat("{{ used_time }}")
    };
    
    let flagCount = 0;
    const board = document.getElementById('board');
    const flagCountEl = document.getElementById('flag-count');
    const mineCountEl = document.getElementById('mine-count');
    const messageEl = document.getElementById('message');
    
    // ä¸€æ¬¡æ€§åˆ›å»ºæ‰€æœ‰DOMå…ƒç´ 
    function initBoard() {
        board.style.gridTemplateColumns = `repeat(${GAME_DATA.cols}, 30px)`;
        board.innerHTML = '';
        
        const fragment = document.createDocumentFragment();
        flagCount = 0;
        let hasRevealedMine = false;
        let revealedCount = 0;
        
        for (let i = 0; i < GAME_DATA.rows; i++) {
            for (let j = 0; j < GAME_DATA.cols; j++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.row = i;
                cell.dataset.col = j;
                
                const state = GAME_DATA.state[i][j];
                const isMine = GAME_DATA.mines_matrix[i][j];
                
                if (state === 2) {
                    cell.classList.add('flagged');
                    cell.textContent = 'ğŸš©';
                    flagCount++;
                } else if (state === 1) {
                    cell.classList.add('revealed');
                    revealedCount++;
                    if (isMine) {
                        cell.classList.add('mine');
                        cell.textContent = 'ğŸ’£';
                        hasRevealedMine = true;
                    } else {
                        const count = countNeighborMines(i, j);
                        if (count > 0) {
                            cell.textContent = count;
                            cell.classList.add(`number-${count}`);
                        }
                    }
                }
                
                // åªæœ‰æ¸¸æˆæœªå®Œæˆæ—¶æ‰æ·»åŠ äº‹ä»¶ç›‘å¬
                if (!GAME_DATA.ended) {
                    cell.onclick = () => handleClick(i, j, 'open');
                    cell.oncontextmenu = (e) => {
                        e.preventDefault();
                        handleClick(i, j, 'flag');
                    };
                    cell.onmousedown = (e) => {
                        if (e.button === 1) {
                            e.preventDefault();
                            handleMiddleClick(i, j);
                        }
                    };
                }
                
                fragment.appendChild(cell);
            }
        }
        
        board.appendChild(fragment);
        updateCounters();
        
        // æ£€æŸ¥æ¸¸æˆçŠ¶æ€å¹¶æ˜¾ç¤ºæ¶ˆæ¯
        checkGameStatus(hasRevealedMine, revealedCount);
    }
    
    function checkGameStatus(hasRevealedMine, revealedCount) {
        if (GAME_DATA.ended) {
            if (GAME_DATA.is_success) {
                // æ¸¸æˆèƒœåˆ©
                messageEl.innerHTML = `
                    ç”¨æ—¶: ${GAME_DATA.used_time.toFixed(2)} ç§’<br>
                `;
                messageEl.className = 'message win';
                
                // èƒœåˆ©æ—¶çš„ç‰¹æ•ˆ
                celebrateWin();
            } else {
                // æ¸¸æˆå¤±è´¥
                messageEl.innerHTML = `
                    æ¸¸æˆç»“æŸï¼ä½ è¸©åˆ°äº†åœ°é›·ï¼<br>
                `;
                messageEl.className = 'message lose';
                
                // æ­ç¤ºæ‰€æœ‰åœ°é›·
                revealAllMines();
            }
        } else if (hasRevealedMine) {
            // æœ¬åœ°æ£€æµ‹åˆ°è¸©é›·ï¼ˆåç«¯å¯èƒ½è¿˜æ²¡æ›´æ–°ï¼‰
            messageEl.textContent = 'ğŸ’¥ æ¸¸æˆç»“æŸï¼ä½ è¸©åˆ°äº†åœ°é›·ï¼';
            messageEl.className = 'message lose';
            revealAllMines();
        } else {
            // æ£€æŸ¥æ˜¯å¦èƒœåˆ©ï¼ˆæœ¬åœ°æ£€æµ‹ï¼‰
            const totalSafeCells = GAME_DATA.rows * GAME_DATA.cols - GAME_DATA.mines;
            if (revealedCount === totalSafeCells) {
                messageEl.innerHTML = `
                    ğŸ‰ æ­å–œä½ èµ¢äº†ï¼ğŸ‰<br>
                    ç”¨æ—¶: ${GAME_DATA.used_time.toFixed(2)} ç§’
                `;
                messageEl.className = 'message win';
                celebrateWin();
            }
        }
    }
    
    function celebrateWin() {
        // èƒœåˆ©åº†ç¥åŠ¨ç”»
        setTimeout(() => {
            for (let i = 0; i < 50; i++) {
                createConfetti();
            }
        }, 100);
    }
    
    function createConfetti() {
        const confetti = document.createElement('div');
        confetti.style.cssText = `
            position: fixed;
            width: 10px;
            height: 10px;
            background: ${['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'][Math.floor(Math.random() * 5)]};
            left: ${Math.random() * 100}vw;
            top: -10px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1000;
            animation: confettiFall 3s linear forwards;
        `;
        document.body.appendChild(confetti);
        
        setTimeout(() => confetti.remove(), 3000);
    }
    
    // æ·»åŠ confettiåŠ¨ç”»æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
    
    function revealAllMines() {
        // æ˜¾ç¤ºæ‰€æœ‰åœ°é›·ä½ç½®
        for (let i = 0; i < GAME_DATA.rows; i++) {
            for (let j = 0; j < GAME_DATA.cols; j++) {
                if (GAME_DATA.mines_matrix[i][j] && GAME_DATA.state[i][j] !== 1) {
                    const cell = board.children[i * GAME_DATA.cols + j];
                    cell.classList.add('revealed', 'mine');
                    cell.textContent = 'ğŸ’£';
                }
            }
        }
    }
    
    function countNeighborMines(row, col) {
        let count = 0;
        for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
                const newRow = row + i, newCol = col + j;
                if (newRow >= 0 && newRow < GAME_DATA.rows && 
                    newCol >= 0 && newCol < GAME_DATA.cols && 
                    GAME_DATA.mines_matrix[newRow][newCol]) {
                    count++;
                }
            }
        }
        return count;
    }
    
    function updateCounters() {
        flagCountEl.textContent = flagCount;
        mineCountEl.textContent = Math.max(0, GAME_DATA.mines - flagCount);
    }
    
    // ç®€åŒ–çš„äº‹ä»¶å¤„ç†
    function handleClick(row, col, action) {
        const form = new FormData();
        form.append('x', row);
        form.append('y', col);
        form.append('act', action);
        form.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        fetch(`/game/${GAME_DATA.id}/action/`, {
            method: 'POST',
            body: form
        }).then(() => location.reload());
    }
    
    function handleMiddleClick(row, col) {
        // å®ç°ä¸­é”®ç‚¹å‡»é€»è¾‘
        const cell = board.children[row * GAME_DATA.cols + col];
        if (!cell.classList.contains('revealed')) return;
        
        // è®¡ç®—å‘¨å›´æ ‡è®°æ•°å’Œæ•°å­—
        const neighborMines = countNeighborMines(row, col);
        let flaggedCount = 0;
        const actions = [];
        
        // æ£€æŸ¥å‘¨å›´8ä¸ªæ ¼å­
        for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
                if (i === 0 && j === 0) continue;
                
                const newRow = row + i;
                const newCol = col + j;
                
                if (newRow >= 0 && newRow < GAME_DATA.rows && 
                    newCol >= 0 && newCol < GAME_DATA.cols) {
                    
                    const neighborState = GAME_DATA.state[newRow][newCol];
                    
                    if (neighborState === 2) { // å·²æ ‡è®°
                        flaggedCount++;
                    } else if (neighborState === 0) { // æœªæ­å¼€ä¸”æœªæ ‡è®°
                        actions.push({x: newRow, y: newCol, act: 'open'});
                    }
                }
            }
        }
        
        // å¦‚æœæ ‡è®°æ•°ç­‰äºå‘¨å›´åœ°é›·æ•°ï¼Œåˆ™æ‰“å¼€æ‰€æœ‰æœªæ ‡è®°çš„é‚»å±…
        if (flaggedCount === neighborMines && actions.length > 0) {
            const form = new FormData();
            form.append('batch_actions', JSON.stringify(actions));
            form.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            fetch(`/game/${GAME_DATA.id}/action/`, {
                method: 'POST',
                body: form
            }).then(() => location.reload());
        }
    }
    
    // åˆå§‹åŒ–
    initBoard();
</script>

{% csrf_token %}
{% endblock %}