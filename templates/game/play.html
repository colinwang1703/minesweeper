{% extends 'base.html' %}

{% block content %}
<div class="game-info">
    <div>åœ°é›·: <span id="mine-count">{{ game.mines }}</span></div>
    <div>æ ‡è®°: <span id="flag-count">0</span></div>
    <div>æ—¶é—´: <span id="time">{{ used_time }}</span>ç§’</div>
</div>

<div class="controls">
    <button id="restart">é‡æ–°å¼€å§‹</button>
    <button onclick="window.location.href='{% url "game:new_game" %}'">æ–°æ¸¸æˆ</button>
    <div id="start-time" style="margin-top: 10px; font-size: 14px; color: #666;">
        {% if start_time_str %}æ¸¸æˆå¼€å§‹æ—¶é—´: {{ start_time_str }}{% endif %}
    </div>
</div>

<div class="board-container">
    <div class="board" id="board"></div>
</div>

<div class="message" id="message"></div>

<script>
    // ä»Djangoä¼ é€’çš„æ•°æ®
    const gameData = {
        gameId: {{ game.id }},
        rows: {{ rows }},
        cols: {{ cols }},
        mines: {{ game.mines }},
        stateMatrix: {{ state_matrix|safe }},
        minesMatrix: {{ mines_matrix|safe }},
        usedTime: parseFloat("{{ used_time }}"),
        gameStarted: "{{ start_time_str }}" !== "",
        gameEnded: {{ game.end_time|yesno:"true,false" }}
    };
    
    // æ¸¸æˆçŠ¶æ€
    let gameState = {
        gameId: gameData.gameId,
        rows: gameData.rows,
        cols: gameData.cols,
        totalMines: gameData.mines,
        board: [],
        flagCount: 0,
        revealedCount: 0,
        gameOver: false,
        gameStarted: gameData.gameStarted,
        gameEnded: gameData.gameEnded
    };
    
    // DOM å…ƒç´ 
    const boardElement = document.getElementById('board');
    const mineCountElement = document.getElementById('mine-count');
    const flagCountElement = document.getElementById('flag-count');
    const timeElement = document.getElementById('time');
    const messageElement = document.getElementById('message');
    const restartButton = document.getElementById('restart');
    
    // åˆå§‹åŒ–æ¸¸æˆ
    function initGame() {
        // é‡ç½®çŠ¶æ€
        gameState.flagCount = 0;
        gameState.revealedCount = 0;
        gameState.gameOver = false;
        
        // åˆå§‹åŒ–æ£‹ç›˜æ•°æ®ç»“æ„
        gameState.board = [];
        for (let i = 0; i < gameState.rows; i++) {
            gameState.board[i] = [];
            for (let j = 0; j < gameState.cols; j++) {
                const state = parseInt(gameData.stateMatrix[i][j]);
                const isMine = parseInt(gameData.minesMatrix[i][j]) === 1;
                
                gameState.board[i][j] = {
                    isMine: isMine,
                    isRevealed: state === 1,
                    isFlagged: state === 2,
                    neighborMines: 0
                };
                
                if (state === 1) gameState.revealedCount++;
                if (state === 2) gameState.flagCount++;
            }
        }
        
        // è®¡ç®—é‚»å±…åœ°é›·æ•°
        for (let i = 0; i < gameState.rows; i++) {
            for (let j = 0; j < gameState.cols; j++) {
                if (!gameState.board[i][j].isMine) {
                    gameState.board[i][j].neighborMines = countNeighborMines(i, j);
                }
            }
        }
        
        // æ£€æŸ¥æ¸¸æˆçŠ¶æ€
        checkGameStatus();
        
        // æ›´æ–°UI
        updateUI();
        updateCounters();
    }
    
    // è®¡ç®—å‘¨å›´åœ°é›·æ•°
    function countNeighborMines(row, col) {
        let count = 0;
        for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
                const newRow = row + i;
                const newCol = col + j;
                if (newRow >= 0 && newRow < gameState.rows && 
                    newCol >= 0 && newCol < gameState.cols && 
                    gameState.board[newRow][newCol].isMine) {
                    count++;
                }
            }
        }
        return count;
    }
    
    // æ›´æ–°UI
    function updateUI() {
        // æ¸…ç©ºæ£‹ç›˜
        boardElement.innerHTML = '';
        
        // è®¾ç½®ç½‘æ ¼
        boardElement.style.gridTemplateColumns = `repeat(${gameState.cols}, 30px)`;
        boardElement.style.gridTemplateRows = `repeat(${gameState.rows}, 30px)`;
        
        // åˆ›å»ºæ ¼å­
        for (let i = 0; i < gameState.rows; i++) {
            for (let j = 0; j < gameState.cols; j++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.row = i;
                cell.dataset.col = j;
                
                const cellData = gameState.board[i][j];
                
                if (cellData.isRevealed) {
                    cell.classList.add('revealed');
                    if (cellData.isMine) {
                        cell.classList.add('mine');
                        cell.textContent = 'ğŸ’£';
                    } else if (cellData.neighborMines > 0) {
                        cell.textContent = cellData.neighborMines;
                        cell.classList.add(`number-${cellData.neighborMines}`);
                    }
                } else if (cellData.isFlagged) {
                    cell.classList.add('flagged');
                    cell.textContent = 'ğŸš©';
                }
                
                // åªæœ‰æ¸¸æˆæœªç»“æŸæ—¶æ‰æ·»åŠ äº‹ä»¶ç›‘å¬
                if (!gameState.gameOver && !gameState.gameEnded) {
                    cell.addEventListener('click', () => handleCellClick(i, j));
                    cell.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        handleRightClick(i, j);
                    });
                    
                    // æ·»åŠ ä¸­é”®ç‚¹å‡»äº‹ä»¶ï¼ˆç‚¹å¼€ä¸€ç‰‡ï¼‰
                    cell.addEventListener('mousedown', (e) => {
                        if (e.button === 1) { // ä¸­é”®
                            e.preventDefault();
                            handleMiddleClick(i, j);
                        }
                    });
                    
                    // æ·»åŠ åŒå‡»äº‹ä»¶ï¼ˆç‚¹å¼€ä¸€ç‰‡ï¼‰
                    cell.addEventListener('dblclick', (e) => {
                        e.preventDefault();
                        handleMiddleClick(i, j);
                    });
                }
                
                boardElement.appendChild(cell);
            }
        }
    }
    
    // æ›´æ–°è®¡æ•°å™¨
    function updateCounters() {
        flagCountElement.textContent = gameState.flagCount;
        const remainingMines = gameState.totalMines - gameState.flagCount;
        mineCountElement.textContent = Math.max(0, remainingMines);
    }
    
    // å‘é€åŠ¨ä½œåˆ°æœåŠ¡å™¨
    async function sendAction(row, col, action) {
        try {
            const formData = new FormData();
            formData.append('x', row);
            formData.append('y', col);
            formData.append('act', action);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            const response = await fetch(`/game/${gameState.gameId}/action/`, {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                location.reload();
            }
        } catch (error) {
            console.error('å‘é€åŠ¨ä½œå¤±è´¥:', error);
        }
    }
    
    // å‘é€æ‰¹é‡åŠ¨ä½œåˆ°æœåŠ¡å™¨
    async function sendBatchAction(actions) {
        try {
            const formData = new FormData();
            formData.append('batch_actions', JSON.stringify(actions));
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            const response = await fetch(`/game/${gameState.gameId}/action/`, {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                location.reload();
            }
        } catch (error) {
            console.error('å‘é€æ‰¹é‡åŠ¨ä½œå¤±è´¥:', error);
        }
    }
    
    // å¤„ç†æ ¼å­ç‚¹å‡»
    function handleCellClick(row, col) {
        if (gameState.gameOver || gameState.gameEnded) return;
        
        const cell = gameState.board[row][col];
        if (cell.isFlagged || cell.isRevealed) return;
        
        // å‘é€æ‰“å¼€åŠ¨ä½œåˆ°æœåŠ¡å™¨
        sendAction(row, col, 'open');
    }
    
    // å¤„ç†å³é”®ç‚¹å‡»
    function handleRightClick(row, col) {
        if (gameState.gameOver || gameState.gameEnded) return;
        
        const cell = gameState.board[row][col];
        if (cell.isRevealed) return;
        
        // å‘é€æ ‡è®°åŠ¨ä½œåˆ°æœåŠ¡å™¨
        sendAction(row, col, 'flag');
    }
    
    // å¤„ç†ä¸­é”®/åŒå‡»ï¼ˆç‚¹å¼€ä¸€ç‰‡ï¼‰
    function handleMiddleClick(row, col) {
        if (gameState.gameOver || gameState.gameEnded) return;
        
        const cell = gameState.board[row][col];
        if (!cell.isRevealed || cell.isMine) return;
        
        // è®¡ç®—å‘¨å›´æ ‡è®°çš„åœ°é›·æ•°
        let flaggedCount = 0;
        const neighbors = [];
        
        for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
                const newRow = row + i;
                const newCol = col + j;
                
                if (newRow >= 0 && newRow < gameState.rows && 
                    newCol >= 0 && newCol < gameState.cols && 
                    !(i === 0 && j === 0)) {
                    
                    const neighbor = gameState.board[newRow][newCol];
                    neighbors.push({row: newRow, col: newCol, cell: neighbor});
                    
                    if (neighbor.isFlagged) {
                        flaggedCount++;
                    }
                }
            }
        }
        
        // å¦‚æœæ ‡è®°æ•°ç­‰äºè¯¥æ ¼å­çš„æ•°å­—ï¼Œåˆ™æ‰“å¼€æ‰€æœ‰æœªæ ‡è®°çš„é‚»å±…
        if (flaggedCount === cell.neighborMines) {
            const actions = [];
            
            for (const neighbor of neighbors) {
                if (!neighbor.cell.isRevealed && !neighbor.cell.isFlagged) {
                    actions.push({
                        x: neighbor.row,
                        y: neighbor.col,
                        act: 'open'
                    });
                }
            }
            
            if (actions.length > 0) {
                sendBatchAction(actions);
            }
        }
    }
    
    // æ£€æŸ¥æ¸¸æˆçŠ¶æ€
    function checkGameStatus() {
        let hasRevealedMine = false;
        let totalSafeCells = gameState.rows * gameState.cols - gameState.totalMines;
        
        // æ£€æŸ¥æ˜¯å¦è¸©åˆ°åœ°é›·
        for (let i = 0; i < gameState.rows; i++) {
            for (let j = 0; j < gameState.cols; j++) {
                const cell = gameState.board[i][j];
                if (cell.isRevealed && cell.isMine) {
                    hasRevealedMine = true;
                    break;
                }
            }
            if (hasRevealedMine) break;
        }
        
        if (hasRevealedMine) {
            gameOver(false);
        } else if (gameState.revealedCount === totalSafeCells) {
            gameOver(true);
        }
    }
    
    // æ¸¸æˆç»“æŸ
    function gameOver(isWin) {
        gameState.gameOver = true;
        
        if (isWin) {
            messageElement.textContent = `æ­å–œä½ èµ¢äº†ï¼ç”¨æ—¶ ${gameData.usedTime.toFixed(2)} ç§’`;
            messageElement.classList.add('win');
        } else {
            messageElement.textContent = 'å¾ˆé—æ†¾ï¼Œä½ è¾“äº†ï¼';
            messageElement.classList.add('lose');
        }
        
        updateUI();
    }
    
    // é‡æ–°å¼€å§‹æŒ‰é’®
    restartButton.addEventListener('click', () => {
        window.location.href = `/game/${gameState.gameId}/`;
    });
    
    // åˆå§‹åŒ–æ¸¸æˆ
    initGame();
</script>

<!-- CSRF token for AJAX requests -->
{% csrf_token %}
{% endblock %}