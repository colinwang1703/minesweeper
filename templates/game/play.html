{% extends 'base.html' %}

{% block content %}
<div class="game-info">
    <div>地雷: <span id="mine-count">{{ game.mines }}</span></div>
    <div>标记: <span id="flag-count">0</span></div>
    <div>时间: <span id="time">{{ used_time }}</span>秒</div>
    {% if game.is_completed %}
    <div class="game-status">
        {% if game.is_success %}
            <span class="status-win">✅ 胜利</span>
        {% else %}
            <span class="status-lose">💥 失败</span>
        {% endif %}
    </div>
    {% endif %}
</div>

<div class="controls">
    <button onclick="window.location.href='{% url "game:new_game" %}'">新游戏</button>
    <div id="start-time" style="margin-top: 10px; font-size: 14px; color: #666;">
        {% if start_time_str %}游戏开始时间: {{ start_time_str }}{% endif %}
    </div>
</div>

<div class="board-container">
    <div class="board" id="board"></div>
</div>

<div class="message" id="message"></div>

<style>
.status-win {
    color: #4CAF50;
    font-weight: bold;
    animation: celebrate 2s ease-in-out;
}

.status-lose {
    color: #f44336;
    font-weight: bold;
}

@keyframes celebrate {
    0%, 100% { transform: scale(1); }
    25% { transform: scale(1.1); }
    50% { transform: scale(1.05); }
    75% { transform: scale(1.1); }
}

.message.win {
    background: linear-gradient(45deg, #4CAF50, #45a049);
    color: white;
    padding: 15px;
    border-radius: 8px;
    font-size: 18px;
    font-weight: bold;
    text-align: center;
    margin: 20px 0;
    animation: winAnimation 3s ease-in-out;
}

.message.lose {
    background: linear-gradient(45deg, #f44336, #da190b);
    color: white;
    padding: 15px;
    border-radius: 8px;
    font-size: 18px;
    font-weight: bold;
    text-align: center;
    margin: 20px 0;
}

@keyframes winAnimation {
    0% { transform: scale(0.8); opacity: 0; }
    20% { transform: scale(1.1); opacity: 1; }
    40% { transform: scale(0.95); }
    60% { transform: scale(1.05); }
    80% { transform: scale(0.98); }
    100% { transform: scale(1); }
}
</style>

<script>
    // 预编译模板数据
    const GAME_DATA = {
        id: {{ game.id }},
        rows: {{ game.rows }},
        cols: {{ game.cols }},
        mines: {{ game.mines }},
        state: {{ state_matrix|safe }},
        mines_matrix: {{ mines_matrix|safe }},
        ended: {{ game.is_completed|yesno:"true,false" }},
        is_success: {{ game.is_success|yesno:"true,false" }},
        used_time: parseFloat("{{ used_time }}")
    };
    
    let flagCount = 0;
    const board = document.getElementById('board');
    const flagCountEl = document.getElementById('flag-count');
    const mineCountEl = document.getElementById('mine-count');
    const messageEl = document.getElementById('message');
    
    // 一次性创建所有DOM元素
    function initBoard() {
        board.style.gridTemplateColumns = `repeat(${GAME_DATA.cols}, 30px)`;
        board.innerHTML = '';
        
        const fragment = document.createDocumentFragment();
        flagCount = 0;
        let hasRevealedMine = false;
        let revealedCount = 0;
        
        for (let i = 0; i < GAME_DATA.rows; i++) {
            for (let j = 0; j < GAME_DATA.cols; j++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.row = i;
                cell.dataset.col = j;
                
                const state = GAME_DATA.state[i][j];
                const isMine = GAME_DATA.mines_matrix[i][j];
                
                if (state === 2) {
                    cell.classList.add('flagged');
                    cell.textContent = '🚩';
                    flagCount++;
                } else if (state === 1) {
                    cell.classList.add('revealed');
                    revealedCount++;
                    if (isMine) {
                        cell.classList.add('mine');
                        cell.textContent = '💣';
                        hasRevealedMine = true;
                    } else {
                        const count = countNeighborMines(i, j);
                        if (count > 0) {
                            cell.textContent = count;
                            cell.classList.add(`number-${count}`);
                        }
                    }
                }
                
                // 只有游戏未完成时才添加事件监听
                if (!GAME_DATA.ended) {
                    cell.onclick = () => handleClick(i, j, 'open');
                    cell.oncontextmenu = (e) => {
                        e.preventDefault();
                        handleClick(i, j, 'flag');
                    };
                    cell.onmousedown = (e) => {
                        if (e.button === 1) {
                            e.preventDefault();
                            handleMiddleClick(i, j);
                        }
                    };
                }
                
                fragment.appendChild(cell);
            }
        }
        
        board.appendChild(fragment);
        updateCounters();
        
        // 检查游戏状态并显示消息
        checkGameStatus(hasRevealedMine, revealedCount);
    }
    
    function checkGameStatus(hasRevealedMine, revealedCount) {
        if (GAME_DATA.ended) {
            if (GAME_DATA.is_success) {
                // 游戏胜利
                messageEl.innerHTML = `
                    用时: ${GAME_DATA.used_time.toFixed(2)} 秒<br>
                `;
                messageEl.className = 'message win';
                
                // 胜利时的特效
                celebrateWin();
            } else {
                // 游戏失败
                messageEl.innerHTML = `
                    游戏结束！你踩到了地雷！<br>
                `;
                messageEl.className = 'message lose';
                
                // 揭示所有地雷
                revealAllMines();
            }
        } else if (hasRevealedMine) {
            // 本地检测到踩雷（后端可能还没更新）
            messageEl.textContent = '💥 游戏结束！你踩到了地雷！';
            messageEl.className = 'message lose';
            revealAllMines();
        } else {
            // 检查是否胜利（本地检测）
            const totalSafeCells = GAME_DATA.rows * GAME_DATA.cols - GAME_DATA.mines;
            if (revealedCount === totalSafeCells) {
                messageEl.innerHTML = `
                    🎉 恭喜你赢了！🎉<br>
                    用时: ${GAME_DATA.used_time.toFixed(2)} 秒
                `;
                messageEl.className = 'message win';
                celebrateWin();
            }
        }
    }
    
    function celebrateWin() {
        // 胜利庆祝动画
        setTimeout(() => {
            for (let i = 0; i < 50; i++) {
                createConfetti();
            }
        }, 100);
    }
    
    function createConfetti() {
        const confetti = document.createElement('div');
        confetti.style.cssText = `
            position: fixed;
            width: 10px;
            height: 10px;
            background: ${['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'][Math.floor(Math.random() * 5)]};
            left: ${Math.random() * 100}vw;
            top: -10px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1000;
            animation: confettiFall 3s linear forwards;
        `;
        document.body.appendChild(confetti);
        
        setTimeout(() => confetti.remove(), 3000);
    }
    
    // 添加confetti动画样式
    const style = document.createElement('style');
    style.textContent = `
        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
    
    function revealAllMines() {
        // 显示所有地雷位置
        for (let i = 0; i < GAME_DATA.rows; i++) {
            for (let j = 0; j < GAME_DATA.cols; j++) {
                if (GAME_DATA.mines_matrix[i][j] && GAME_DATA.state[i][j] !== 1) {
                    const cell = board.children[i * GAME_DATA.cols + j];
                    cell.classList.add('revealed', 'mine');
                    cell.textContent = '💣';
                }
            }
        }
    }
    
    function countNeighborMines(row, col) {
        let count = 0;
        for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
                const newRow = row + i, newCol = col + j;
                if (newRow >= 0 && newRow < GAME_DATA.rows && 
                    newCol >= 0 && newCol < GAME_DATA.cols && 
                    GAME_DATA.mines_matrix[newRow][newCol]) {
                    count++;
                }
            }
        }
        return count;
    }
    
    function updateCounters() {
        flagCountEl.textContent = flagCount;
        mineCountEl.textContent = Math.max(0, GAME_DATA.mines - flagCount);
    }
    
    // 简化的事件处理
    function handleClick(row, col, action) {
        const form = new FormData();
        form.append('x', row);
        form.append('y', col);
        form.append('act', action);
        form.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        fetch(`/game/${GAME_DATA.id}/action/`, {
            method: 'POST',
            body: form
        }).then(() => location.reload());
    }
    
    function handleMiddleClick(row, col) {
        // 实现中键点击逻辑
        const cell = board.children[row * GAME_DATA.cols + col];
        if (!cell.classList.contains('revealed')) return;
        
        // 计算周围标记数和数字
        const neighborMines = countNeighborMines(row, col);
        let flaggedCount = 0;
        const actions = [];
        
        // 检查周围8个格子
        for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
                if (i === 0 && j === 0) continue;
                
                const newRow = row + i;
                const newCol = col + j;
                
                if (newRow >= 0 && newRow < GAME_DATA.rows && 
                    newCol >= 0 && newCol < GAME_DATA.cols) {
                    
                    const neighborState = GAME_DATA.state[newRow][newCol];
                    
                    if (neighborState === 2) { // 已标记
                        flaggedCount++;
                    } else if (neighborState === 0) { // 未揭开且未标记
                        actions.push({x: newRow, y: newCol, act: 'open'});
                    }
                }
            }
        }
        
        // 如果标记数等于周围地雷数，则打开所有未标记的邻居
        if (flaggedCount === neighborMines && actions.length > 0) {
            const form = new FormData();
            form.append('batch_actions', JSON.stringify(actions));
            form.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            fetch(`/game/${GAME_DATA.id}/action/`, {
                method: 'POST',
                body: form
            }).then(() => location.reload());
        }
    }
    
    // 初始化
    initBoard();
</script>

{% csrf_token %}
{% endblock %}