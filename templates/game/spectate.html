{% extends "base.html" %}
{% block content %}
<div class="spectate-header">
    <h2>观看 {{ game.user.username }} 的游戏</h2>
    <div class="spectate-info">
        <span class="game-size">{{ game.rows }}x{{ game.cols }}</span>
        <span class="mines-info">💣 <span id="mines-left">{{ game.mines }}</span></span>
        <span class="time-info">⏱️ <span id="game-time">0</span>秒</span>
        <span class="watch-time-left">👁️ 观看剩余: <span id="watch-time-left">-</span>秒</span>
        <span class="spectator-info">👥 <span id="spectator-count">{{ spectator_count }}</span> 观众</span>
    </div>
</div>

<div class="game-container">
    <div class="minefield" id="minefield">
        <!-- 游戏网格将通过JavaScript生成 -->
    </div>
</div>

<div class="spectate-controls">
    <button onclick="goBack()" class="btn-back">返回直播列表</button>
</div>

<style>
.spectate-header {
    text-align: center;
    margin-bottom: 20px;
}

.spectate-info {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 10px;
    font-size: 1.1em;
    flex-wrap: wrap;
}

.spectate-info > span {
    padding: 5px 10px;
    background: #f8f9fa;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.watch-time-left {
    color: #ffc107;
    font-weight: bold;
}

.watch-time-left.warning {
    color: #dc3545;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.5; }
}

.game-container {
    display: flex;
    justify-content: center;
    margin: 20px 0;
}

.minefield {
    display: inline-grid;
    gap: 1px;
    padding: 10px;
    background-color: #bbb;
    border: 3px solid #888;
}

.cell {
    width: 25px;
    height: 25px;
    background-color: #ccc;
    border: 2px outset #ccc;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    cursor: default;
}

.cell.revealed {
    background-color: #eee;
    border: 1px solid #999;
}

.cell.flagged {
    background-color: #ffd700;
}

.cell.mine {
    background-color: #ff0000;
    color: white;
}

.cell.number-1 { color: #0000ff; }
.cell.number-2 { color: #008000; }
.cell.number-3 { color: #ff0000; }
.cell.number-4 { color: #000080; }
.cell.number-5 { color: #800000; }
.cell.number-6 { color: #008080; }
.cell.number-7 { color: #000000; }
.cell.number-8 { color: #808080; }

.spectate-controls {
    text-align: center;
    margin-top: 20px;
}

.btn-back {
    background: #6c757d;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.btn-back:hover {
    background: #5a6268;
}

.status-message {
    text-align: center;
    padding: 20px;
    margin: 20px 0;
    border-radius: 8px;
}

.game-won {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.game-lost {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.watch-ended {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.redirect-message {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}
</style>

<script>
// 游戏数据和状态管理
const gameData = {
    rows: {{ game.rows }},
    cols: {{ game.cols }},
    gameId: {{ game.id }},
    username: '{{ game.user.username }}',
    startTime: {% if game.start_time %}'{{ game.start_time.isoformat }}'{% else %}null{% endif %}
};

let updateInterval = null;
let redirectTimer = null;

// 初始化雷区
function initMinefield() {
    const minefield = document.getElementById('minefield');
    minefield.style.gridTemplateColumns = `repeat(${gameData.cols}, 1fr)`;
    
    for (let i = 0; i < gameData.rows; i++) {
        for (let j = 0; j < gameData.cols; j++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.id = `cell-${i}-${j}`;
            minefield.appendChild(cell);
        }
    }
}

// 更新游戏显示
function updateGameDisplay(data) {
    updateGameInfo(data);
    updateWatchTimeLeft(data);
    updateMinefield(data);
    
    if (data.is_completed) {
        showGameResult(data.is_success);
    }
}

// 更新游戏信息
function updateGameInfo(data) {
    document.getElementById('mines-left').textContent = data.mines_left;
    document.getElementById('game-time').textContent = data.used_time;
    document.getElementById('spectator-count').textContent = data.spectator_count;
}

// 更新观看剩余时间
function updateWatchTimeLeft(data) {
    const watchTimeLeft = document.getElementById('watch-time-left');
    if (!watchTimeLeft || data.time_left === undefined) return;
    
    watchTimeLeft.textContent = data.time_left;
    
    // 剩余时间少于30秒时显示警告
    if (data.time_left <= 30 && data.time_left > 0) {
        watchTimeLeft.parentElement.classList.add('warning');
    }
    
    // 观看时间结束
    if (data.time_left <= 0) {
        showEndMessage('观看时间已结束', 'watch-ended');
    }
}

// 更新雷区显示
function updateMinefield(data) {
    for (let i = 0; i < gameData.rows; i++) {
        for (let j = 0; j < gameData.cols; j++) {
            const cell = document.getElementById(`cell-${i}-${j}`);
            const state = data.state[i][j];
            const number = data.numbers[i][j];
            
            updateCellDisplay(cell, state, number);
        }
    }
}

// 更新单个格子显示
function updateCellDisplay(cell, state, number) {
    cell.className = 'cell';
    cell.textContent = '';
    
    if (state === 2) { // 标记
        cell.classList.add('flagged');
        cell.textContent = '🚩';
    } else if (state === 1) { // 已揭开
        cell.classList.add('revealed');
        if (number === -1) {
            cell.classList.add('mine');
            cell.textContent = '💣';
        } else if (number > 0) {
            cell.classList.add(`number-${number}`);
            cell.textContent = number;
        }
    }
}

// 显示游戏结果
function showGameResult(isWin) {
    if (document.querySelector('.status-message')) return;
    
    stopUpdating();
    
    const message = isWin ? '🎉 游戏胜利！' : '💥 游戏失败！';
    const description = `${gameData.username} ${isWin ? '成功完成了游戏' : '踩到了地雷'}`;
    const className = isWin ? 'game-won' : 'game-lost';
    
    showStatusMessage(message, description, className);
    scheduleRedirect('游戏已结束，5秒后自动返回直播列表...', 5000);
}

// 显示结束消息
function showEndMessage(message, className) {
    if (document.querySelector('.status-message')) return;
    
    stopUpdating();
    
    const gameContainer = document.querySelector('.game-container');
    gameContainer.innerHTML = `
        <div class="status-message ${className}">
            <h3>观看已结束</h3>
            <p>${message}</p>
        </div>
    `;
    
    scheduleRedirect('观看已结束，3秒后自动返回直播列表...', 3000);
}

// 显示状态消息
function showStatusMessage(title, description, className) {
    const statusDiv = document.createElement('div');
    statusDiv.className = `status-message ${className}`;
    statusDiv.innerHTML = `
        <h3>${title}</h3>
        <p>${description}</p>
    `;
    
    document.querySelector('.game-container').appendChild(statusDiv);
}

// 安排重定向
function scheduleRedirect(message, delay) {
    showRedirectMessage(message);
    redirectTimer = setTimeout(goBack, delay);
}

// 显示重定向消息
function showRedirectMessage(message) {
    if (document.querySelector('.redirect-message')) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'status-message redirect-message';
    messageDiv.innerHTML = `
        <p>${message}</p>
        <button onclick="cancelRedirect()" class="btn-back" style="margin-left: 10px;">取消自动跳转</button>
    `;
    
    document.querySelector('.spectate-controls').appendChild(messageDiv);
}

// 取消重定向
function cancelRedirect() {
    if (redirectTimer) {
        clearTimeout(redirectTimer);
        redirectTimer = null;
    }
    
    const redirectMessage = document.querySelector('.redirect-message');
    if (redirectMessage) {
        redirectMessage.remove();
    }
}

// 停止更新
function stopUpdating() {
    if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
    }
}

// 清理资源
function cleanup() {
    stopUpdating();
    if (redirectTimer) {
        clearTimeout(redirectTimer);
        redirectTimer = null;
    }
}

// 返回直播列表
function goBack() {
    cleanup();
    window.location.href = '/game/live/';
}

// 获取游戏数据
function fetchGameData() {
    fetch(`/game/${gameData.gameId}/spectate/data/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error(data.error);
                showEndMessage(data.error, 'watch-ended');
                return;
            }
            updateGameDisplay(data);
        })
        .catch(error => {
            console.error('获取游戏数据失败:', error);
            showEndMessage('获取游戏数据失败，观看已结束', 'watch-ended');
        });
}

// 页面卸载前清理
window.addEventListener('beforeunload', cleanup);

// 初始化
initMinefield();
fetchGameData();
updateInterval = setInterval(fetchGameData, 2000);
</script>
{% endblock %}