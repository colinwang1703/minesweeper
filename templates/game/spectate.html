{% extends 'base.html' %}

{% block content %}
<div class="spectate-header">
    <h2>è§‚çœ‹ {{ game.user.username }} çš„æ¸¸æˆ</h2>
</div>

<div class="game-info">
    <div>B<span id="mine-count">{{ game.mines }}</span></div>
    <div>F<span id="flag-count">0</span></div>
    <div>T<span id="time">0.00</span>s</div>
    <div>A<span id="spectator-count">1</span></div>
</div>

<div class="controls">
    <button onclick="window.location.href='{% url "game:live_games" %}'">è¿”å›ç›´æ’­åˆ—è¡¨</button>
    <div id="start-time" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
    <div id="game-status" style="margin-top: 5px; font-size: 14px; color: #888;"></div>
</div>

<div class="board-container">
    <div class="board" id="board"></div>
</div>

<div class="message" id="message"></div>

<!-- è§‚ä¼—èŠå¤©åŒºåŸŸ -->
<div class="spectator-panel" id="spectator-panel">
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-input">
        <input type="text" id="chat-input" placeholder="å‘é€æ¶ˆæ¯..." maxlength="200">
        <button id="send-chat">å‘é€</button>
    </div>
</div>

<style>
/* å¤åˆ¶ play.html çš„å®Œæ•´æ ·å¼ */
.game-info {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 20px;
    font-size: 18px;
    font-weight: bold;
}

.controls {
    text-align: center;
    margin-bottom: 20px;
}

.controls button {
    padding: 10px 20px;
    font-size: 16px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.controls button:hover {
    background: #0056b3;
}

.board-container {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
}

.board {
    display: grid;
    gap: 1px;
    background-color: #999;
    padding: 5px;
    border-radius: 5px;
}

.cell {
    width: 30px;
    height: 30px;
    background-color: #ccc;
    border: 2px outset #ccc;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    cursor: default; /* è§‚ä¼—æ¨¡å¼ä¸å¯ç‚¹å‡» */
    user-select: none;
}

.cell.revealed {
    background-color: #eee;
    border: 1px inset #eee;
}

.cell.flagged {
    background-color: #ffeb3b;
}

.cell.mine {
    background-color: #f44336;
    color: white;
}

.cell.number-1 { color: #0000ff; }
.cell.number-2 { color: #008000; }
.cell.number-3 { color: #ff0000; }
.cell.number-4 { color: #000080; }
.cell.number-5 { color: #800000; }
.cell.number-6 { color: #008080; }
.cell.number-7 { color: #000000; }
.cell.number-8 { color: #808080; }

.spectate-header {
    text-align: center;
    margin-bottom: 20px;
}

.spectate-header h2 {
    color: #333;
    margin: 0;
}

.status-win {
    color: #4CAF50;
    font-weight: bold;
    animation: celebrate 2s ease-in-out;
}

.status-lose {
    color: #f44336;
    font-weight: bold;
}

@keyframes celebrate {
    0%, 100% { transform: scale(1); }
    25% { transform: scale(1.1); }
    50% { transform: scale(1.05); }
    75% { transform: scale(1.1); }
}

.message.win {
    background: linear-gradient(45deg, #4CAF50, #45a049);
    color: white;
    padding: 15px;
    border-radius: 8px;
    font-size: 18px;
    font-weight: bold;
    text-align: center;
    margin: 20px 0;
    animation: winAnimation 3s ease-in-out;
}

.message.lose {
    background: linear-gradient(45deg, #f44336, #da190b);
    color: white;
    padding: 15px;
    border-radius: 8px;
    font-size: 18px;
    font-weight: bold;
    text-align: center;
    margin: 20px 0;
}

@keyframes winAnimation {
    0% { transform: scale(0.8); opacity: 0; }
    20% { transform: scale(1.1); opacity: 1; }
    40% { transform: scale(0.95); }
    60% { transform: scale(1.05); }
    80% { transform: scale(0.98); }
    100% { transform: scale(1); }
}

.spectator-panel {
    margin-top: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    max-height: 300px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 10px;
    min-height: 200px;
    border: 1px solid #eee;
    padding: 10px;
    border-radius: 4px;
    background: #f9f9f9;
}

.chat-input {
    display: flex;
    gap: 10px;
}

.chat-input input {
    flex: 1;
    padding: 5px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.chat-input button {
    padding: 5px 15px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.chat-input button:hover {
    background: #0056b3;
}

.chat-message {
    margin-bottom: 8px;
    padding: 5px;
    border-radius: 4px;
}

.chat-message.system {
    background: #e3f2fd;
    color: #1976d2;
    font-style: italic;
}

.chat-message.user {
    background: #f3e5f5;
}

.connection-status {
    padding: 5px 10px;
    border-radius: 4px;
    margin: 10px 0;
    text-align: center;
    font-size: 12px;
}

.connection-status.connected {
    background: #d4edda;
    color: #155724;
}

.connection-status.disconnected {
    background: #f8d7da;
    color: #721c24;
}

.spectator-mode {
    background: #fff3cd;
    color: #856404;
    padding: 10px;
    border-radius: 4px;
    text-align: center;
    margin: 10px 0;
    border: 1px solid #ffeaa7;
}
</style>

<script>
    console.log('å¼€å§‹åŠ è½½ spectate.html');
    
    // æ¸¸æˆæ•°æ®
    let GAME_DATA = {
        id: {{ game.id }},
        rows: {{ game.rows }},
        cols: {{ game.cols }},
        mines: {{ game.mines }},
        state: {{ state_matrix|safe }},
        mines_matrix: {{ mines_matrix|safe }},
        is_completed: {{ game.is_completed|yesno:"true,false" }},
        is_success: {{ game.is_success|yesno:"true,false" }},
        used_time: parseFloat("{{ used_time|default:"0" }}"),  // æ·»åŠ é»˜è®¤å€¼
        is_owner: false, // è§‚ä¼—æ¨¡å¼
        owner_username: '{{ game.user.username|escapejs }}'  // è½¬ä¹‰ç”¨æˆ·å
    };
    
    console.log('GAME_DATA:', GAME_DATA);
    
    // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
    if (!GAME_DATA.state || !GAME_DATA.mines_matrix) {
        console.error('æ¸¸æˆæ•°æ®ä¸å®Œæ•´:', {
            state: GAME_DATA.state,
            mines_matrix: GAME_DATA.mines_matrix
        });
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        document.addEventListener('DOMContentLoaded', function() {
            const messageEl = document.getElementById('message');
            if (messageEl) {
                messageEl.innerHTML = 'âŒ æ¸¸æˆæ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                messageEl.className = 'message lose';
            }
        });
    }
    
    // WebSocketè¿æ¥
    let gameSocket;
    let connectionStatus = document.createElement('div');
    connectionStatus.className = 'connection-status disconnected';
    connectionStatus.textContent = 'æ­£åœ¨è¿æ¥...';
    document.querySelector('.game-info').appendChild(connectionStatus);
    
    // æ·»åŠ è§‚ä¼—æ¨¡å¼æç¤º
    let spectatorMode = document.createElement('div');
    spectatorMode.className = 'spectator-mode';
    spectatorMode.textContent = `ğŸ‘ï¸ è§‚ä¼—æ¨¡å¼ - æ­£åœ¨è§‚çœ‹ ${GAME_DATA.owner_username} çš„æ¸¸æˆ`;
    document.querySelector('.controls').appendChild(spectatorMode);
    
    // DOMå…ƒç´ 
    const board = document.getElementById('board');
    const flagCountEl = document.getElementById('flag-count');
    const mineCountEl = document.getElementById('mine-count');
    const timeEl = document.getElementById('time');
    const messageEl = document.getElementById('message');
    const spectatorCountEl = document.getElementById('spectator-count');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendChatBtn = document.getElementById('send-chat');
    const gameStatusEl = document.getElementById('game-status');
    
    let flagCount = 0;
    let spectatorCount = 1;
    
    // åˆå§‹åŒ–WebSocketè¿æ¥
    function initWebSocket() {
        const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
        const wsPath = `${wsScheme}://${window.location.host}/ws/game/${GAME_DATA.id}/`;
        
        console.log('æ­£åœ¨è¿æ¥ WebSocket:', wsPath);
        
        try {
            gameSocket = new WebSocket(wsPath);
            
            gameSocket.onopen = function(e) {
                console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                connectionStatus.className = 'connection-status connected';
                connectionStatus.textContent = 'å·²è¿æ¥';
                addChatMessage('å·²è¿æ¥åˆ°æ¸¸æˆæˆ¿é—´', 'system');
            };
            
            gameSocket.onmessage = function(e) {
                console.log('æ”¶åˆ°WebSocketæ¶ˆæ¯:', e.data);
                try {
                    const data = JSON.parse(e.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', error);
                }
            };
            
            gameSocket.onclose = function(e) {
                console.log('WebSocketè¿æ¥å·²å…³é—­, code:', e.code, 'reason:', e.reason);
                connectionStatus.className = 'connection-status disconnected';
                connectionStatus.textContent = 'è¿æ¥æ–­å¼€';
                
                // å°è¯•é‡è¿
                setTimeout(() => {
                    console.log('å°è¯•é‡æ–°è¿æ¥...');
                    initWebSocket();
                }, 3000);
            };
            
            gameSocket.onerror = function(e) {
                console.error('WebSocketé”™è¯¯:', e);
                connectionStatus.className = 'connection-status disconnected';
                connectionStatus.textContent = 'è¿æ¥é”™è¯¯';
            };
        } catch (error) {
            console.error('åˆ›å»ºWebSocketè¿æ¥å¤±è´¥:', error);
            connectionStatus.className = 'connection-status disconnected';
            connectionStatus.textContent = 'è¿æ¥å¤±è´¥';
        }
    }
    
    // å¤„ç†WebSocketæ¶ˆæ¯
    function handleWebSocketMessage(data) {
        console.log('å¤„ç†WebSocketæ¶ˆæ¯:', data);
        
        switch(data.type) {
            case 'connection_established':
                console.log('è¿æ¥å·²å»ºç«‹:', data.message);
                break;
                
            case 'game_state':
                console.log('æ”¶åˆ°æ¸¸æˆçŠ¶æ€');
                updateGameData(data.data);
                updateBoard();
                break;
                
            case 'game_update':
                console.log('æ”¶åˆ°æ¸¸æˆæ›´æ–°');
                updateGameData(data.data);
                updateBoard();
                if (data.user) {
                    addChatMessage(`${data.user} è¿›è¡Œäº†æ“ä½œ`, 'system');
                }
                break;
                
            case 'user_joined':
                spectatorCount++;
                spectatorCountEl.textContent = spectatorCount;
                addChatMessage(`${data.user} åŠ å…¥è§‚çœ‹`, 'system');
                break;
                
            case 'user_left':
                spectatorCount = Math.max(1, spectatorCount - 1);
                spectatorCountEl.textContent = spectatorCount;
                addChatMessage(`${data.user} ç¦»å¼€äº†`, 'system');
                break;
                
            case 'chat_message':
                addChatMessage(`${data.user}: ${data.message}`, 'user');
                break;
                
            case 'error':
                console.error('WebSocketé”™è¯¯:', data.message);
                addChatMessage(`é”™è¯¯: ${data.message}`, 'system');
                break;
                
            default:
                console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', data.type);
        }
    }
    
    // æ›´æ–°æ¸¸æˆæ•°æ®
    function updateGameData(newData) {
        if (!newData) return;
        
        console.log('æ›´æ–°æ¸¸æˆæ•°æ®:', newData);
        
        // å¤„ç†åç«¯å‘é€çš„æ•°æ®æ ¼å¼è½¬æ¢
        if (newData.state_matrix && !newData.state) {
            newData.state = newData.state_matrix;
        }
        if (newData.mines_matrix_data && !newData.mines_matrix) {
            newData.mines_matrix = newData.mines_matrix_data;
        }
        
        GAME_DATA = {...GAME_DATA, ...newData};
        
        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        if (newData.used_time !== undefined) {
            timeEl.textContent = newData.used_time.toFixed(2);
        }
        
        // æ›´æ–°å¼€å§‹æ—¶é—´æ˜¾ç¤º
        if (newData.start_time) {
            const startTime = new Date(newData.start_time);
            document.getElementById('start-time').textContent = 
                `æ¸¸æˆå¼€å§‹æ—¶é—´: ${startTime.toLocaleTimeString()}`;
        }
        
        // æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤º
        updateGameStatus();
    }
    
    // æ›´æ–°æ¸¸æˆçŠ¶æ€æ˜¾ç¤º
    function updateGameStatus() {
        if (GAME_DATA.is_completed) {
            if (GAME_DATA.is_success) {
                gameStatusEl.textContent = `ğŸ‰ ${GAME_DATA.owner_username} æ¸¸æˆèƒœåˆ©ï¼`;
                gameStatusEl.style.color = '#4CAF50';
            } else {
                gameStatusEl.textContent = `ğŸ’¥ ${GAME_DATA.owner_username} æ¸¸æˆå¤±è´¥ï¼`;
                gameStatusEl.style.color = '#f44336';
            }
        } else {
            gameStatusEl.textContent = `ğŸ® ${GAME_DATA.owner_username} æ­£åœ¨æ¸¸æˆä¸­...`;
            gameStatusEl.style.color = '#007bff';
        }
    }
    
    // æ›´æ–°å•ä¸ªæ ¼å­æ˜¾ç¤º
    function updateCellDisplay(cell, state, isMine, i, j) {
        cell.className = 'cell';
        cell.textContent = '';
        
        if (state === 2) {
            cell.classList.add('flagged');
            cell.textContent = 'ğŸš©';
        } else if (state === 1) {
            cell.classList.add('revealed');
            if (isMine) {
                cell.classList.add('mine');
                cell.textContent = 'ğŸ’£';
            } else {
                const count = countNeighborMines(i, j);
                if (count > 0) {
                    cell.textContent = count;
                    cell.classList.add(`number-${count}`);
                }
            }
        }
    }
    
    // æ›´æ–°æ•´ä¸ªæ£‹ç›˜
    function updateBoard() {
        console.log('æ›´æ–°æ£‹ç›˜');
        
        if (!GAME_DATA.state || !GAME_DATA.mines_matrix) {
            console.log('æ¸¸æˆæ•°æ®ä¸å®Œæ•´ï¼Œè·³è¿‡æ£‹ç›˜æ›´æ–°');
            return;
        }
        
        flagCount = 0;
        for (let i = 0; i < GAME_DATA.rows; i++) {
            for (let j = 0; j < GAME_DATA.cols; j++) {
                const cell = board.children[i * GAME_DATA.cols + j];
                if (!cell) continue;
                
                const state = GAME_DATA.state[i][j];
                const isMine = GAME_DATA.mines_matrix[i][j];
                
                updateCellDisplay(cell, state, isMine, i, j);
                
                if (state === 2) {
                    flagCount++;
                }
            }
        }
        updateCounters();
        checkGameStatus();
    }
    
    // åˆå§‹åŒ–æ£‹ç›˜
    function initBoard() {
        console.log('åˆå§‹åŒ–æ£‹ç›˜');
        
        board.style.gridTemplateColumns = `repeat(${GAME_DATA.cols}, 30px)`;
        board.innerHTML = '';
        
        const fragment = document.createDocumentFragment();
        flagCount = 0;
        
        for (let i = 0; i < GAME_DATA.rows; i++) {
            for (let j = 0; j < GAME_DATA.cols; j++) {
                const cell = createCell(i, j);
                fragment.appendChild(cell);
            }
        }
        
        board.appendChild(fragment);
        updateCounters();
        checkGameStatus();
    }
    
    // åˆ›å»ºå•ä¸ªæ ¼å­
    function createCell(i, j) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.row = i;
        cell.dataset.col = j;
        
        if (GAME_DATA.state && GAME_DATA.mines_matrix) {
            const state = GAME_DATA.state[i][j];
            const isMine = GAME_DATA.mines_matrix[i][j];
            
            updateCellDisplay(cell, state, isMine, i, j);
            
            if (state === 2) {
                flagCount++;
            }
        }
        
        return cell;
    }
    
    // è®¡ç®—é‚»å±…åœ°é›·æ•°
    function countNeighborMines(row, col) {
        let count = 0;
        for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
                const newRow = row + i, newCol = col + j;
                if (newRow >= 0 && newRow < GAME_DATA.rows && 
                    newCol >= 0 && newCol < GAME_DATA.cols && 
                    GAME_DATA.mines_matrix[newRow][newCol]) {
                    count++;
                }
            }
        }
        return count;
    }
    
    // æ›´æ–°è®¡æ•°å™¨
    function updateCounters() {
        flagCountEl.textContent = flagCount;
        mineCountEl.textContent = Math.max(0, GAME_DATA.mines - flagCount);
    }
    
    // æ£€æŸ¥æ¸¸æˆçŠ¶æ€
    function checkGameStatus() {
        if (GAME_DATA.is_completed) {
            if (GAME_DATA.is_success) {
                messageEl.innerHTML = `ğŸ‰ ${GAME_DATA.owner_username} æ¸¸æˆèƒœåˆ©ï¼ç”¨æ—¶: ${GAME_DATA.used_time.toFixed(2)} ç§’`;
                messageEl.className = 'message win';
            } else {
                messageEl.innerHTML = `ğŸ’¥ ${GAME_DATA.owner_username} æ¸¸æˆå¤±è´¥ï¼`;
                messageEl.className = 'message lose';
                revealAllMines();
            }
        }
    }
    
    // æ˜¾ç¤ºæ‰€æœ‰åœ°é›·
    function revealAllMines() {
        for (let i = 0; i < GAME_DATA.rows; i++) {
            for (let j = 0; j < GAME_DATA.cols; j++) {
                if (GAME_DATA.mines_matrix[i][j] && GAME_DATA.state[i][j] !== 1) {
                    const cell = board.children[i * GAME_DATA.cols + j];
                    if (cell) {
                        cell.classList.add('revealed', 'mine');
                        cell.textContent = 'ğŸ’£';
                    }
                }
            }
        }
    }
    
    // å‘é€èŠå¤©æ¶ˆæ¯
    function sendChatMessage(message) {
        if (gameSocket && gameSocket.readyState === WebSocket.OPEN) {
            gameSocket.send(JSON.stringify({
                type: 'spectator_action',
                data: {
                    type: 'chat',
                    message: message,
                    timestamp: new Date().toISOString()
                }
            }));
        } else {
            addChatMessage('è¿æ¥å·²æ–­å¼€ï¼Œæ— æ³•å‘é€æ¶ˆæ¯', 'system');
        }
    }
    
    // æ·»åŠ èŠå¤©æ¶ˆæ¯
    function addChatMessage(message, type = 'user') {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${type}`;
        messageDiv.textContent = message;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // èŠå¤©åŠŸèƒ½äº‹ä»¶ç›‘å¬
    sendChatBtn.addEventListener('click', () => {
        const message = chatInput.value.trim();
        if (message) {
            sendChatMessage(message);
            chatInput.value = '';
        }
    });
    
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendChatBtn.click();
        }
    });
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
        initBoard();
        initWebSocket();
    });
    
    // å¦‚æœDOMå·²ç»åŠ è½½å®Œæˆï¼Œç›´æ¥åˆå§‹åŒ–
    if (document.readyState === 'loading') {
        // DOMè¿˜åœ¨åŠ è½½ä¸­ï¼Œç­‰å¾…DOMContentLoadedäº‹ä»¶
    } else {
        // DOMå·²ç»åŠ è½½å®Œæˆ
        console.log('DOMå·²åŠ è½½ï¼Œç›´æ¥åˆå§‹åŒ–');
        initBoard();
        initWebSocket();
    }
</script>

{% csrf_token %}
{% endblock %}