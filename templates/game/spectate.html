{% extends "base.html" %}
{% block content %}
<div class="spectate-header">
    <h2>è§‚çœ‹ {{ game.user.username }} çš„æ¸¸æˆ</h2>
    <div class="spectate-info">
        <span class="game-size">{{ game.rows }}x{{ game.cols }}</span>
        <span class="mines-info">ğŸ’£ <span id="mines-left">{{ game.mines }}</span></span>
        <span class="time-info">â±ï¸ <span id="game-time">0</span>ç§’</span>
        <span class="watch-time-left">ğŸ‘ï¸ è§‚çœ‹å‰©ä½™: <span id="watch-time-left">-</span>ç§’</span>
        <span class="spectator-info">ğŸ‘¥ <span id="spectator-count">{{ spectator_count }}</span> è§‚ä¼—</span>
    </div>
</div>

<div class="game-container">
    <div class="minefield" id="minefield">
        <!-- æ¸¸æˆç½‘æ ¼å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
    </div>
</div>

<div class="spectate-controls">
    <button onclick="goBack()" class="btn-back">è¿”å›ç›´æ’­åˆ—è¡¨</button>
</div>

<style>
.spectate-header {
    text-align: center;
    margin-bottom: 20px;
}

.spectate-info {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 10px;
    font-size: 1.1em;
    flex-wrap: wrap;
}

.spectate-info > span {
    padding: 5px 10px;
    background: #f8f9fa;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.watch-time-left {
    color: #ffc107;
    font-weight: bold;
}

.watch-time-left.warning {
    color: #dc3545;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.5; }
}

.game-container {
    display: flex;
    justify-content: center;
    margin: 20px 0;
}

.minefield {
    display: inline-grid;
    gap: 1px;
    padding: 10px;
    background-color: #bbb;
    border: 3px solid #888;
}

.cell {
    width: 25px;
    height: 25px;
    background-color: #ccc;
    border: 2px outset #ccc;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    cursor: default;
}

.cell.revealed {
    background-color: #eee;
    border: 1px solid #999;
}

.cell.flagged {
    background-color: #ffd700;
}

.cell.mine {
    background-color: #ff0000;
    color: white;
}

.cell.number-1 { color: #0000ff; }
.cell.number-2 { color: #008000; }
.cell.number-3 { color: #ff0000; }
.cell.number-4 { color: #000080; }
.cell.number-5 { color: #800000; }
.cell.number-6 { color: #008080; }
.cell.number-7 { color: #000000; }
.cell.number-8 { color: #808080; }

.spectate-controls {
    text-align: center;
    margin-top: 20px;
}

.btn-back {
    background: #6c757d;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.btn-back:hover {
    background: #5a6268;
}

.status-message {
    text-align: center;
    padding: 20px;
    margin: 20px 0;
    border-radius: 8px;
}

.game-won {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.game-lost {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.watch-ended {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.redirect-message {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}
</style>

<script>
// æ¸¸æˆæ•°æ®å’ŒçŠ¶æ€ç®¡ç†
const gameData = {
    rows: {{ game.rows }},
    cols: {{ game.cols }},
    gameId: {{ game.id }},
    username: '{{ game.user.username }}',
    startTime: {% if game.start_time %}'{{ game.start_time.isoformat }}'{% else %}null{% endif %}
};

let updateInterval = null;
let redirectTimer = null;

// åˆå§‹åŒ–é›·åŒº
function initMinefield() {
    const minefield = document.getElementById('minefield');
    minefield.style.gridTemplateColumns = `repeat(${gameData.cols}, 1fr)`;
    
    for (let i = 0; i < gameData.rows; i++) {
        for (let j = 0; j < gameData.cols; j++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.id = `cell-${i}-${j}`;
            minefield.appendChild(cell);
        }
    }
}

// æ›´æ–°æ¸¸æˆæ˜¾ç¤º
function updateGameDisplay(data) {
    updateGameInfo(data);
    updateWatchTimeLeft(data);
    updateMinefield(data);
    
    if (data.is_completed) {
        showGameResult(data.is_success);
    }
}

// æ›´æ–°æ¸¸æˆä¿¡æ¯
function updateGameInfo(data) {
    document.getElementById('mines-left').textContent = data.mines_left;
    document.getElementById('game-time').textContent = data.used_time;
    document.getElementById('spectator-count').textContent = data.spectator_count;
}

// æ›´æ–°è§‚çœ‹å‰©ä½™æ—¶é—´
function updateWatchTimeLeft(data) {
    const watchTimeLeft = document.getElementById('watch-time-left');
    if (!watchTimeLeft || data.time_left === undefined) return;
    
    watchTimeLeft.textContent = data.time_left;
    
    // å‰©ä½™æ—¶é—´å°‘äº30ç§’æ—¶æ˜¾ç¤ºè­¦å‘Š
    if (data.time_left <= 30 && data.time_left > 0) {
        watchTimeLeft.parentElement.classList.add('warning');
    }
    
    // è§‚çœ‹æ—¶é—´ç»“æŸ
    if (data.time_left <= 0) {
        showEndMessage('è§‚çœ‹æ—¶é—´å·²ç»“æŸ', 'watch-ended');
    }
}

// æ›´æ–°é›·åŒºæ˜¾ç¤º
function updateMinefield(data) {
    for (let i = 0; i < gameData.rows; i++) {
        for (let j = 0; j < gameData.cols; j++) {
            const cell = document.getElementById(`cell-${i}-${j}`);
            const state = data.state[i][j];
            const number = data.numbers[i][j];
            
            updateCellDisplay(cell, state, number);
        }
    }
}

// æ›´æ–°å•ä¸ªæ ¼å­æ˜¾ç¤º
function updateCellDisplay(cell, state, number) {
    cell.className = 'cell';
    cell.textContent = '';
    
    if (state === 2) { // æ ‡è®°
        cell.classList.add('flagged');
        cell.textContent = 'ğŸš©';
    } else if (state === 1) { // å·²æ­å¼€
        cell.classList.add('revealed');
        if (number === -1) {
            cell.classList.add('mine');
            cell.textContent = 'ğŸ’£';
        } else if (number > 0) {
            cell.classList.add(`number-${number}`);
            cell.textContent = number;
        }
    }
}

// æ˜¾ç¤ºæ¸¸æˆç»“æœ
function showGameResult(isWin) {
    if (document.querySelector('.status-message')) return;
    
    stopUpdating();
    
    const message = isWin ? 'ğŸ‰ æ¸¸æˆèƒœåˆ©ï¼' : 'ğŸ’¥ æ¸¸æˆå¤±è´¥ï¼';
    const description = `${gameData.username} ${isWin ? 'æˆåŠŸå®Œæˆäº†æ¸¸æˆ' : 'è¸©åˆ°äº†åœ°é›·'}`;
    const className = isWin ? 'game-won' : 'game-lost';
    
    showStatusMessage(message, description, className);
    scheduleRedirect('æ¸¸æˆå·²ç»“æŸï¼Œ5ç§’åè‡ªåŠ¨è¿”å›ç›´æ’­åˆ—è¡¨...', 5000);
}

// æ˜¾ç¤ºç»“æŸæ¶ˆæ¯
function showEndMessage(message, className) {
    if (document.querySelector('.status-message')) return;
    
    stopUpdating();
    
    const gameContainer = document.querySelector('.game-container');
    gameContainer.innerHTML = `
        <div class="status-message ${className}">
            <h3>è§‚çœ‹å·²ç»“æŸ</h3>
            <p>${message}</p>
        </div>
    `;
    
    scheduleRedirect('è§‚çœ‹å·²ç»“æŸï¼Œ3ç§’åè‡ªåŠ¨è¿”å›ç›´æ’­åˆ—è¡¨...', 3000);
}

// æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
function showStatusMessage(title, description, className) {
    const statusDiv = document.createElement('div');
    statusDiv.className = `status-message ${className}`;
    statusDiv.innerHTML = `
        <h3>${title}</h3>
        <p>${description}</p>
    `;
    
    document.querySelector('.game-container').appendChild(statusDiv);
}

// å®‰æ’é‡å®šå‘
function scheduleRedirect(message, delay) {
    showRedirectMessage(message);
    redirectTimer = setTimeout(goBack, delay);
}

// æ˜¾ç¤ºé‡å®šå‘æ¶ˆæ¯
function showRedirectMessage(message) {
    if (document.querySelector('.redirect-message')) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'status-message redirect-message';
    messageDiv.innerHTML = `
        <p>${message}</p>
        <button onclick="cancelRedirect()" class="btn-back" style="margin-left: 10px;">å–æ¶ˆè‡ªåŠ¨è·³è½¬</button>
    `;
    
    document.querySelector('.spectate-controls').appendChild(messageDiv);
}

// å–æ¶ˆé‡å®šå‘
function cancelRedirect() {
    if (redirectTimer) {
        clearTimeout(redirectTimer);
        redirectTimer = null;
    }
    
    const redirectMessage = document.querySelector('.redirect-message');
    if (redirectMessage) {
        redirectMessage.remove();
    }
}

// åœæ­¢æ›´æ–°
function stopUpdating() {
    if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
    }
}

// æ¸…ç†èµ„æº
function cleanup() {
    stopUpdating();
    if (redirectTimer) {
        clearTimeout(redirectTimer);
        redirectTimer = null;
    }
}

// è¿”å›ç›´æ’­åˆ—è¡¨
function goBack() {
    cleanup();
    window.location.href = '/game/live/';
}

// è·å–æ¸¸æˆæ•°æ®
function fetchGameData() {
    fetch(`/game/${gameData.gameId}/spectate/data/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error(data.error);
                showEndMessage(data.error, 'watch-ended');
                return;
            }
            updateGameDisplay(data);
        })
        .catch(error => {
            console.error('è·å–æ¸¸æˆæ•°æ®å¤±è´¥:', error);
            showEndMessage('è·å–æ¸¸æˆæ•°æ®å¤±è´¥ï¼Œè§‚çœ‹å·²ç»“æŸ', 'watch-ended');
        });
}

// é¡µé¢å¸è½½å‰æ¸…ç†
window.addEventListener('beforeunload', cleanup);

// åˆå§‹åŒ–
initMinefield();
fetchGameData();
updateInterval = setInterval(fetchGameData, 2000);
</script>
{% endblock %}